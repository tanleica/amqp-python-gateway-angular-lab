services:
  # ============================================
  # 1) ANGULAR FRONTEND (served via nginx)
  # ============================================
  angular-frontend:
    build:
      context: ./angular-frontend
      dockerfile: Dockerfile
    container_name: amqp_fe
    ports:
      - "55555:80"
    networks:
      - amqp_lab_net
    depends_on:
      - gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ============================================
  # 2) .NET GATEWAY (OCELOT - NO SSL)
  # ============================================
  gateway:
    build:
      context: ./gateway-dotnet
      dockerfile: Dockerfile
    container_name: amqp_gateway
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5009
    ports:
      - "5009:5009"
    networks:
      - amqp_lab_net
    depends_on:
      - python-backend
      - signalr-node
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5009/healthz"]
      interval: 10s
      timeout: 4s
      retries: 5

  # ============================================
  # 3) PYTHON BACKEND
  # ============================================
  python-backend:
    build:
      context: ./python-backend
      dockerfile: Dockerfile
    container_name: amqp_python
    environment:
      - RABBIT_HOST=rabbitmq
      - RABBIT_PORT=5672
      - RABBIT_USER=guest
      - RABBIT_PASS=guest
    ports:
      - "8081:8081"
    networks:
      - amqp_lab_net
    depends_on:
      - rabbitmq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/python-backend/health"]
      interval: 10s
      timeout: 4s
      retries: 5

  # ============================================
  # 4) NODE SIGNALR
  # ============================================
  signalr-node:
    build:
      context: ./signalr-node
      dockerfile: Dockerfile
    container_name: amqp_signalr
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "7001:6001"
    networks:
      - amqp_lab_net
    depends_on:
      - redis
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:6001/health || exit 1"]
      interval: 10s
      timeout: 4s
      retries: 5

  # ============================================
  # 5) RABBITMQ
  # ============================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: amqp_rabbit
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "56729:5672"
      - "15679:15672"
    networks:
      - amqp_lab_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # 6) REDIS (SignalR backplane)
  # ============================================
  redis:
    image: redis:7
    container_name: amqp_redis
    ports:
      - "6379:6379"
    networks:
      - amqp_lab_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

networks:
  amqp_lab_net:
    driver: bridge

