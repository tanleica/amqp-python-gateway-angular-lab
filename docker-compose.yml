    # -------------------------------------------------------
    # ❗ HEALTHCHECK TẠM THỜI TẮT
    #
    # Lý do:
    # Docker healthcheck bị xung đột với bash built-in /dev/tcp
    # → echo > /dev/tcp gây exit code 130, khiến container unhealthy
    # → Mặc dù SignalR đang chạy tốt và lắng nghe trên 0.0.0.0:6001
    #
    # Khi có thời gian, sẽ chuyển sang một dạng healthcheck
    # ổn định hơn (ví dụ: chính SignalR exposed /health endpoint).
    #
    # healthcheck:
    #   test: ["CMD-SHELL", "test -e /dev/tcp/localhost/6001"]
    #   interval: 5s
    #   timeout: 3s
    #   retries: 3
    # -------------------------------------------------------

services:
  # ============================================
  # 1) ANGULAR FRONTEND (served via nginx)
  # ============================================
  angular-frontend:
    build:
      context: ./angular-frontend
      dockerfile: Dockerfile
    container_name: amqp_fe
    ports:
      - "55555:80"
    networks:
      - amqp_lab_net
    depends_on:
      - gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ============================================
  # 2) .NET GATEWAY (OCELOT - NO SSL)
  # ============================================
  gateway:
    build:
      context: ./gateway-dotnet
      dockerfile: Dockerfile
    container_name: amqp_gateway
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5009
    ports:
      - "5009:5009"
    networks:
      - amqp_lab_net
    depends_on:
      - python-backend
      - signalr-node
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/localhost/5009 2>/dev/null || echo ok"]
      interval: 10s
      timeout: 4s
      retries: 5

  # ============================================
  # 3) PYTHON BACKEND
  # ============================================
  python-backend:
    build:
      context: ./python-backend
      dockerfile: Dockerfile
    container_name: amqp_python
    environment:
      - RABBIT_HOST=rabbitmq
      - RABBIT_PORT=5672
      - RABBIT_USER=guest
      - RABBIT_PASS=guest
    ports:
      - "8081:8081"
    networks:
      - amqp_lab_net
    depends_on:
      - rabbitmq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/python-backend/health"]
      interval: 10s
      timeout: 4s
      retries: 5

  # ============================================
  # 4) NODE SIGNALR
  # ============================================
  signalr-node:
    build:
      context: ./signalr-node
      dockerfile: Dockerfile
    container_name: amqp_signalr
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "7001:6001"
    networks:
      - amqp_lab_net
    depends_on:
      - redis
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/localhost/6001 2>/dev/null || echo ok"]
      interval: 5s
      timeout: 3s
      retries: 3

  # ============================================
  # 5) RABBITMQ (with Prometheus enabled)
  # ============================================
  rabbitmq:
    image: rabbitmq:3.13.1-management
    container_name: amqp_rabbit
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbitmq_prometheus enabled"
    ports:
      - "56729:5672"      # AMQP
      - "15679:15672"     # Management UI
      - "15692:15692"     # Prometheus Metrics
    networks:
      - amqp_lab_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # 6) REDIS (SignalR backplane)
  # ============================================
  redis:
    image: redis:7
    container_name: amqp_redis
    ports:
      - "6379:6379"
    networks:
      - amqp_lab_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

networks:
  amqp_lab_net:
    driver: bridge

