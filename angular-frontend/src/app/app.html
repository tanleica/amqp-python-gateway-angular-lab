<div class="page">

  <!-- Header -->
  <header class="header">
    <div class="left">
      <strong>AMQP Lab Adamantium Edition</strong>
    </div>

    <div class="right" [class.online]="signalr.$connected()">
      <span class="dot"></span>
      {{ signalr.$connected() ? 'Online' : signalr.$connecting() ? 'Connectingâ€¦' : 'Offline' }}
    </div>
  </header>

  <main class="container">

<div class="tabs-wrapper">
  <button 
    class="tab-item" 
    [class.active]="$selectedTab() === 'lab'"
    (click)="$selectedTab.set('lab')">
      ðŸš€ AMQP Lab
  </button>

  <button 
    class="tab-item" 
    [class.active]="$selectedTab() === 'advanced'"
    (click)="$selectedTab.set('advanced')">
      ðŸ“Š Prometheus
  </button>

  <button
    class="tab-item"
    [class.active]="$selectedTab() === 'prom'"
    (click)="$selectedTab.set('prom')">
      ðŸ’Ž Advanced
  </button>

</div>


@if ($selectedTab() === 'lab') {

    <!-- Declare Exchange -->
    <section class="card">
      <h2>Declare Exchange</h2>
      <input placeholder="Exchange Name"
        [ngModel]="$exchange()"
        (ngModelChange)="setExchange($event)" />
      <button (click)="declareExchange()">Declare</button>
    </section>

    <!-- Declare Queue -->
    <section class="card">
      <h2>Declare Queue</h2>
      <input placeholder="Queue Name"
        [ngModel]="$queue()"
        (ngModelChange)="setQueue($event)" />
      <button (click)="declareQueue()">Declare</button>
    </section>

    <!-- Bind -->
    <section class="card">
      <h2>Bind Queue</h2>
      <input placeholder="Exchange"
        [ngModel]="$exchange()"
        (ngModelChange)="setExchange($event)" />
      <input placeholder="Queue"
        [ngModel]="$queue()"
        (ngModelChange)="setQueue($event)" />
      <input placeholder="Routing Key"
        [ngModel]="$routingKey()"
        (ngModelChange)="setRoutingKey($event)" />
      <button (click)="bind()">Bind</button>
    </section>

    <!-- Publish -->
    <section class="card">
      <h2>Publish</h2>

      <input placeholder="Exchange"
        [ngModel]="$exchange()"
        (ngModelChange)="setExchange($event)" />

      <input placeholder="Routing Key"
        [ngModel]="$routingKey()"
        (ngModelChange)="setRoutingKey($event)" />

      <textarea placeholder="Message"
        rows="3"
        [ngModel]="$message()"
        (ngModelChange)="setMessage($event)"></textarea>

      <button class="primary" (click)="publish()">Publish</button>
    </section>

    <!-- Consume -->
    <section class="card">
      <h2>Consume Queue</h2>
      <input placeholder="Queue"
        [ngModel]="$queue()"
        (ngModelChange)="setQueue($event)" />
      <button (click)="consume()">Consume</button>

      @if ($consumeResult()) {
      <pre class="output">
{{ $consumeResult() | json }}
      </pre>
      }
    </section>

    <!-- Realtime Events -->
    <section class="card">
      <h2>Realtime Events</h2>

      <div class="event-list">
        @for (m of signalr.$messages(); track $index) {
        <div class="logbox">
          <span class="material-symbols-rounded"></span>
          <span>{{ m | json }}</span>
        </div>
        }
      </div>
    </section>

    <!-- Logs -->
    <section class="card">
      <h2>Logs</h2>
      <pre class="logbox">
{{ $logs().join('\n') }}
      </pre>
    </section>

}

@if ($selectedTab() === 'prom') {
  <h2>Prometheus Dashboard</h2>

  @if ($metrics()) {
  @let m = $metrics();
  <div>
  
    <p><b>Connections:</b> {{ m!.rabbitmqConnections }}</p>
    <p><b>Queues:</b> {{ m!.rabbitmqQueues }}</p>
    <p><b>Messages Ready:</b> {{ m!.messagesReady }}</p>
    <p><b>Messages Unacked:</b> {{ m!.messagesUnacked }}</p>
    <p><b>Total Messages:</b> {{ m!.messagesTotal }}</p>

  </div>
  } @else {
    <h4>Not fetched</h4>
  }
}

@if ($selectedTab() === 'advanced') {
  <div class="panel">
    <h3>AMQP Advanced Metrics</h3>

    <pre>{{ $stats() | json }}</pre>

    <h4>DLQ Peek</h4>
    <input placeholder="Queue name" [(ngModel)]="dlqQueue">

    <button (click)="peekDlq()">Peek DLQ</button>
    <pre>{{ $dlq() | json }}</pre>

    <button (click)="requeueDlq()">Requeue to Main</button>
  </div>
}

  </main>

</div>
